@def $VPN = (
zaborona+
);

@def $WAN_4 = eth0;
@def $WAN_6 = eth0;
@def $VPN_ADDR_4 = (
192.168.224.0/22
192.168.228.0/22
);

@def $ALLOWED_NETWORKS_V4 = (
74.82.42.42/32
8.8.8.8/32
8.8.4.4/32
1.1.1.1/32
1.0.0.1/32
176.103.130.130/32
176.103.130.131/32
176.103.130.132/32
176.103.130.134/32
176.103.130.136/32
176.103.130.137/32
5.45.192.0/18
5.255.192.0/18
37.9.64.0/18
37.140.128.0/18
77.75.152.0/21
77.88.0.0/18
84.201.128.0/18
87.250.224.0/19
93.158.128.0/18
95.108.128.0/17
100.43.64.0/19
109.235.160.0/21
130.193.32.0/19
141.8.128.0/18
149.5.244.0/22
154.47.0.0/16
178.154.128.0/17
185.32.185.0/24
185.32.186.0/24
185.71.76.0/22
199.21.96.0/22
199.36.240.0/22
213.180.192.0/19
5.61.16.0/21
5.61.232.0/21
79.137.157.0/24
79.137.183.0/24
94.100.176.0/20
95.163.32.0/19
95.163.248.0/21
128.140.168.0/21
178.22.88.0/21
178.237.16.0/20
185.5.136.0/22
185.16.148.0/22
185.16.244.0/22
188.93.56.0/21
194.186.63.0/24
195.211.20.0/22
195.211.128.0/22
195.218.168.0/24
208.87.92.0/22
217.20.144.0/20
217.69.128.0/20
185.6.244.0/22
185.30.176.0/22
195.218.190.0/23
95.163.144.0/24
5.181.60.0/22
45.84.128.0/22
45.136.20.0/22
79.137.174.0/23
79.137.240.0/21
85.192.32.0/22
87.240.128.0/18
89.208.84.0/22
89.208.196.0/22
89.208.208.0/22
89.208.216.0/21
89.208.228.0/22
93.186.224.0/20
95.142.192.0/20
95.163.34.0/23
95.163.36.0/22
95.163.40.0/21
95.163.48.0/20
95.163.180.0/22
95.163.208.0/21
95.163.216.0/22
95.213.0.0/18
178.237.24.0/20
185.16.246.0/23
185.29.130.0/24
185.32.248.0/22
185.187.63.0/24
185.226.52.0/22
213.219.212.0/22
193.0.170.0/23
50.117.0.0/27
62.213.108.142/32
88.217.190.96/27
193.84.255.0/24
83.137.54.41/32
85.192.48.0/21
88.210.0.0/18
89.20.144.0/21
89.222.152.0/21
91.200.28.0/22
91.227.52.0/23
94.143.52.0/22
185.76.252.0/22
194.88.208.0/23
195.177.205.0/24
212.118.32.0/19
51.254.201.70/32
145.239.95.188/32
151.80.149.182/32
217.182.78.61/32
217.182.157.141/32
91.217.153.39/32
52.28.234.188/32
89.184.80.139/32
91.203.69.175/32
104.31.94.209/32
104.31.95.209/32
104.24.104.202/32
104.24.105.202/32
104.28.30.164/32
104.28.31.164/32
192.88.99.0/24
51.254.96.26/32
54.36.30.17/32
77.74.179.130/32
93.159.230.60/32
212.5.110.40/32
4.31.208.86/32
93.159.231.25/32
185.85.15.26/32
178.248.232.183/32
195.93.246.234/32
195.93.247.69/32
186.2.163.12/32
178.248.233.32/32
178.248.233.26/32
178.248.232.60/32
178.210.84.61/32
80.247.32.208/32
84.201.148.246/32
92.53.124.104/32
87.250.251.92/32
104.20.73.219/32
104.20.74.219/32
172.67.3.106/32
178.248.233.60/32
82.202.190.240/32
45.60.34.164/32
45.60.40.164/32
194.84.83.151/32
194.84.120.183/32
193.232.151.138/32
104.26.2.111/32
104.26.3.111/32
172.67.70.154/32
);

@def $ALLOWED_NETWORKS_V6 = (
2620:10f:d000::/44
2a02:6b8::/32
2a00:1148::/32
2a00:a300::/32
2a00:b4c0::/32
2a00:bdc0::/36
2a00:bdc0:e006::/48
2001:4860:4860::/112
2a00:bdc0:e003::/48
2a00:bdc0:e004::/46
2a00:bdc0:e008::/48
2a00:bdc0:f000::/36
2001:678:384::/48
2a02:5180::/32
2a03:2480::/33
2a04:4b40::/29
2a00:5a60::ad1:0ff/128
2a00:5a60::ad2:0ff/128
2a00:5a60::bad1:0ff/128
2a00:5a60::bad2:0ff/128
2a03:6f00:1::5c35:768c/128
2606:4700:20::ac43:469a/128
2606:4700:20::681a:26f/128
2606:4700:20::681a:36f/128
2a00:5a60::01:ff/128
2a00:5a60::02:ff/128
);


table filter {
  chain ZABORONA_V4 {
      daddr $ALLOWED_NETWORKS_V4 ACCEPT;
  }
  chain FORWARD {
      policy DROP;
      mod conntrack ctstate INVALID DROP;
      if $WAN_4 of $VPN mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT;
      if $VPN of $WAN_4 jump ZABORONA_V4;
  }
 }

table nat {
   chain POSTROUTING {
       saddr $VPN_ADDR_4 of $WAN_4 MASQUERADE;
   }
   chain PREROUTING {
        # Балансировка меджду демонами OpenVPN
       if $WAN_4 protocol tcp dport 1194 mod conntrack ctstate NEW mod statistic mode random probability 0.50000000000 REDIRECT to-ports 1195;

       # Перенаправление DNS запросов на локальный серверв dnsmasq
       saddr 192.168.228.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
       }
      saddr 192.168.224.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
    }
}

# IPv6:
domain ip6 {
   table filter {
       chain ZABORONA_V6 {
           daddr $ALLOWED_NETWORKS_V6 ACCEPT;
       }
       chain FORWARD {
           policy DROP;
           mod conntrack ctstate INVALID DROP;
           if $WAN_6 of $VPN mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT;
           if $VPN of $WAN_6 jump ZABORONA_V6;
           
       }
   }
}
